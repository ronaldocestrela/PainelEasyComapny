@page "/"
@page "/dashboard"
@rendermode InteractiveServer
@using System.Globalization
@using WebCliente.Services
@using WebCliente.Models
@inject IAuthService AuthService
@inject IReportService ReportService
@inject NavigationManager Navigation

@if (!isLoading)
{
    @if (isAuthenticated)
    {
        <div class="dashboard-container">
    @* <div class="dashboard-header"> *@
        @* <div class="filter-section">
            <div class="filter-group">
                <label>Data</label>
                <select class="form-select">
                    <option>Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Conta</label>
                <select class="form-select">
                    <option>Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Campanha</label>
                <select class="form-select">
                    <option>Todos</option>
                </select>
            </div>
        </div> *@
        @* <div class="tools-section">
            <button class="btn btn-outline-secondary">
                <i class="bi bi-table"></i> Tabela
            </button>
            <button class="btn btn-outline-secondary">
                <i class="bi bi-phone"></i> Mobile
            </button>
            <button class="btn btn-outline-secondary">
                <i class="bi bi-bar-chart"></i> Resultado Analítico
            </button>
        </div> *@
    @* </div> *@

    <div class="dashboard-content">
        <div class="row">
            <!-- Comissão Total Card -->
            <div class="col-md-6 mb-4">
                <div class="card commission-card">
                    <div class="card-body">
                        <h5 class="card-title text-white">Comissão Total</h5>
                        <h2 class="commission-value text-white">R$ @ComissaoTotal.ToString("N2", new CultureInfo("pt-BR"))</h2>
                    </div>
                </div>
            </div>

            <!-- Funil de Conversão -->
            <div class="col-md-6 mb-4">
                <div class="card funnel-card">
                    <div class="card-body">
                        <div class="funnel-container">
                            <div class="funnel-section cadastros">
                                <span class="funnel-label">Cadastros</span>
                                <span class="funnel-value">@Cadastros</span>
                            </div>
                            <div class="funnel-section ftds">
                                <span class="funnel-label">FTD's</span>
                                <span class="funnel-value">@FTDs</span>
                            </div>
                            <div class="funnel-section cpa-qual">
                                <span class="funnel-label">CPA Qual.</span>
                                <span class="funnel-value">@CPAQual</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- RVS por Campanha -->
            <div class="col-md-6 mb-4">
                <div class="card metrics-card">
                    <div class="card-body">
                        <h5 class="card-title">RVS por Campanha</h5>
                        <div class="total-value">R$ @RVSTotal</div>
                        <div class="metrics-list">
                            @foreach (var campanha in CampanhasRVS)
                            {
                                <div class="metric-item">
                                    <span class="metric-label">@campanha.Nome</span>
                                    <div class="metric-bar">
                                        <div class="metric-progress" style="width: @(campanha.Valor / RVSTotal * 100)%"></div>
                                    </div>
                                    <span class="metric-value">R$ @campanha.Valor</span>
                                </div>
                            }
                        </div>
                        <div class="disclaimer">
                            * O RVS é uma previsão de ganhos; o valor final é fechado no final do mês.
                        </div>
                    </div>
                </div>
            </div>

            <!-- CPA por Campanha -->
            <div class="col-md-6 mb-4">
                <div class="card metrics-card">
                    <div class="card-body">
                        <h5 class="card-title">CPA por Campanha</h5>
                        <div class="total-value">R$ @CPATotal.ToString("N0")</div>
                        <div class="metrics-list">
                            @foreach (var campanha in CampanhasCPA)
                            {
                                <div class="metric-item">
                                    <span class="metric-label">@campanha.Nome</span>
                                    <div class="metric-bar cpa-bar">
                                        <div class="metric-progress cpa-progress" style="width: @(campanha.Valor / CPATotal * 100)%"></div>
                                    </div>
                                    <span class="metric-value">R$ @campanha.Valor.ToString("N0")</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    }
    else
    {
        <div class="alert alert-warning" role="alert">
            <h4>Acesso Negado</h4>
            <p>Você precisa estar autenticado para acessar esta página.</p>
            <a href="/login" class="btn btn-primary">Ir para Login</a>
        </div>
    }
}
else
{
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
}

@code {
    private List<ReportDto> reports = new();
    private decimal ComissaoTotal = 0;
    private int Cadastros = 0;
    private int FTDs = 0;
    private int CPAQual = 0;
    private int RVSTotal = 0;
    private decimal CPATotal = 0;
    private bool isAuthenticated = false;
    private bool isLoading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && AuthService != null)
        {
            // Inicializar o AuthService
            await AuthService.InitializeAsync();
            
            // Verificar autenticação
            isAuthenticated = AuthService.IsAuthenticated;
            isLoading = false;
            
            // Se não estiver autenticado, redirecionar para login
            if (!isAuthenticated)
            {
                Navigation.NavigateTo("/login", forceLoad: true);
                return;
            }

            // Carregar dados dos reports
            await LoadReportsData();
            
            StateHasChanged();
        }
    }

    private async Task LoadReportsData()
    {
        try
        {
            // Carregar estatísticas mensais para o funil de conversão
            var monthlyStats = await ReportService.GetMonthlyStatsAsync();
            if (monthlyStats != null)
            {
                Cadastros = monthlyStats.TotalClicks;
                FTDs = monthlyStats.TotalFtds;
                ComissaoTotal = monthlyStats.TotalDeposits;
                CPAQual = (int)monthlyStats.TotalCpa; // Usando o CPA total como CPA qualificado
            }

            // Carregar todos os reports para as outras métricas
            var reportsData = await ReportService.GetAllReportsAsync();
            if (reportsData != null)
            {
                reports = reportsData;
                CalculateMetrics();
                UpdateCampanhasMetrics();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar dados dos reports: {ex.Message}");
        }
    }

    private void CalculateMetrics()
    {
        // As métricas principais (Cadastros, FTDs, ComissaoTotal, CPAQual) vêm do endpoint monthly-stats
        // Calcular apenas as métricas adicionais necessárias
        
        // Calcular RVS (Revenue Value Share) - simplificação baseada nos deposits
        RVSTotal = (int)(ComissaoTotal / 10); // 10% do total como RVS
        
        // Calcular CPA total (já vem do endpoint, mas manter para consistência)
        CPATotal = ComissaoTotal / Math.Max(FTDs, 1); // Evitar divisão por zero
    }

    private List<CampanhaMetrica> CampanhasRVS = new();
    private List<CampanhaMetrica> CampanhasCPA = new();

    private void UpdateCampanhasMetrics()
    {
        // Agrupar por campanha e calcular métricas
        var campanhasGroup = reports
            .GroupBy(r => r.CampaignName)
            .Select(g => new {
                Nome = g.Key,
                Valor = g.Sum(r => r.Deposits)
            })
            .OrderByDescending(c => c.Valor)
            .ToList();

        CampanhasRVS = campanhasGroup
            .Select(c => new CampanhaMetrica { Nome = c.Nome, Valor = (int)(c.Valor / 10) })
            .ToList();

        CampanhasCPA = campanhasGroup
            .Select(c => new CampanhaMetrica { 
                Nome = c.Nome, 
                Valor = c.Valor / Math.Max(reports.Where(r => r.CampaignName == c.Nome).Sum(r => r.Ftds), 1) 
            })
            .ToList();
    }

    public class CampanhaMetrica
    {
        public string Nome { get; set; } = string.Empty;
        public decimal Valor { get; set; }
    }
}